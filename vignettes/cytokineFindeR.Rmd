---
title: "How to use CytokineFindeR"
author: "Jeffrey Tang"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{cytokineFindeR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The following is a brief introduction on the usage of `CytokineFindeR`. 

This vignette will outline the following procedures:
1) Setting up the design matrix for the linear models
2) Loading in the demo data `golimumab` from `GSE92415` on GEO. The data set is subset specifically for ulcerative colitis cell isolates looking at the gene expression difference for golimumab, which is an anti-TNF drug, between week 0 and week 6. 
3) Running the benchmark analysis in parallel using `future`
4) Data visualization which shows p-values 

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Load the R packages
```{r setup}
library(cytokineFindeR)
library(tidyverse)
```

# Pull up demo data (GSE92415) which holds a cleaned up expression set and meta data subset for the treatment (golimumab) on ulcerative colitus patients
```{r}
data(golimumab)

obs_id <- golimumab$metadata$`subject:ch1`
treatment <- golimumab$metadata$`visit:ch1`

eset <- golimumab$eset
```

# Pre-filtered databases against CytoSig cytokines
```{r}
# load the default databases list of lists
data("dbs_all")
dbs <- dbs_all
data("beta")
```

# Set up the design matrix for demo data 
```{r}
# Input treatment: difference between week 0 and week 6
# input obs_id if paired data (in this case we do have paired data), GSM IDs different for same sample IDs due to different time points

design <- create_design(treatment, obs_id, eset)
design_mat <- design$design
dupcor <- design$dupcor
```

# run preprocess
```{r}
preprocess_list <- preprocess_eset(eset, dbs)
eset_f <- preprocess_list$eset_f
dbs_f <- preprocess_list$dbs_f
```



# Call the database, 
# list out the methods to benchmark, 
# run `cytokinefinder()`
# The result should return a nested list of benchmark results
```{r, warning=FALSE}
methods <- c("cfgsea", 
             "gsva_limma", 
             "pca_limma")

results <- run_lri_methods(eset_f,
                           design_mat,
                           dbs_f,
                           methods,
                           treatment = treatment,
                           obs_id = obs_id,
                           correlation = dupcor$consensus
                          )

cytosig <- cytosig_custom_ridge(eset, 
                     design_mat, 
                     obs_id = obs_id, 
                     correlation = dupcor$consensus, 
                     beta = beta)
```

# Restructure the data into a tibble:
```{r}
golimumab_treatment <- list(TNF = list(benchmarks = results))
golimumab_tibble <- benchlist_to_tbl(results_list = golimumab_treatment,
                                     study_type = "treatment")
golimumab_tibble
```
